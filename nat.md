---
title: NAT(Network Address Translate)
link: /nat
description: 
draft: true
tags: [Network, NAT]
date: 2023-12-14
banner: /images/github-actions-banner.png
---

## NAT란?

원어는 Network Address Translation 이다. 말 그대로 네트워크 주소를 변환 하는 일을 한다. 굳이 인지 하고 있지 않더라도  WIFI를 사용하고 있을 경우에도 NAT를 이용하고 있을 확률이 매우 높다. NAT를 사용하는 이유는 크게 2가지로 나눌 수 있다. 

1. IP 주소 부족 해결
2. 보안 향상

### IP 주소 부족 핵결
현재 주로 사용되고 있는 사용하는 IPv4(IP Version 4) 이다. IP 프로토콜의 4번째 버전이라는 의미이고 IPv4는 32비트의 주소 공간을 가지고 있다. 
최대 $2^32$ 개의 주소를 사용할 수 있다는 의미다.

$$
2^32 = 4294967296
$$

약 43억개의 주소 공간이 있다. 충분하다고 생각 되지만 이 43억개의 주소 공간은 각 클래스마다 정의된 사설 IP 주소, 멀티캐스트를 위해 할당된 멀티캐스트 주소, 아직 할당 되니 않은 대역을 제외하면 약 37억개 가 된다.

지구의 인구가 80역명 정도 되니 공평하게 나누자고 한다면 가용한 IP주소를 40억개로 보고 개산하더라도 1인당 0.5개의 IP주소가 할당 될 수 있겠다. 

하지만 요즘 우리는 1인당 최소한 하나 이상의 IP주소가 필요하다. 

> 인터넷을 사용하고 있지 않더라도 4G 망이나 5G 망을 사용하고 있다면 휴대전화에 IP주소가 할당 된다. 





### NAT를 사용하는 하는경우
 공유기를 사용하고 있고 서버가 할당 받은 IP가 사설IP 인경우이다. DDNS 클라이언트가 실행되는 단말기 NAT 뒤에 있으므로 단말기 할당 받은 주소는 사설IP일 경우가 크다. 
당연한 이야기이지만 할당받은 IP주소를 DDNS 서버로 보낸다면 DDNS 서버는 사설 주소를 바인당 하기 때문에 정상적으로 접속이 되지 않는다. 


#### NAT 사용여부 확인
NAT를 사용할 때와 사용하지 않을 때 설정 방법이 다르다. 

> NAT 는 **N**etwork **A**ddress **T**ranslation의 약자로 네트워크 주소 변환 이라고 한다. 우리가 쓰는 인터넷 공유기가  NAT 기능을 수행한다. 인터넷 공유기를 사용하고 있다면 NAT 를 사용하고 있을 확률이 높다. 

> 공인 IP를 할당받은 경우라도 보안상의 이유로 NAT를 사용하는 경우가 있으므로 [여기](https://nordvpn.com/what-is-my-ip/)서 확인한 IP주소와 내가 할당 받은 IP주소가 같은지  확인 해야 한다. 

> 아래 명령을 통해 할당 받은 IP를 확인할 수 있다. 
```bash
echo `curl https://domains.google.com/checkip --silent`
```



### NAT Hole Puncing
앞에서 설명 하였듯이 단말이 NAT 뒤에 있다면 내부망에서 외부의 단말에 TCP나 UDP 열결을 요청 할 수 있지만 외부망에서 내무 망으로는 연결을 요청할 수 없다. 그렇다면 통신을 하고자 하는 두 단말이 각기 다른 NAT망 내에 있는 경우를 생각해1보자. 일반적인 방법으로는 통신이 불가능 하다는 것을 알 수 있다.


하지만 우리는 단말이 NAT내부 있는지 외부에 있는지 고려 하지 않고 화상회의나 영상통화, 파일전송등을 하고 있다. 어떻게 이런 동작이 가능한지 알아 보자.

통신하고자 하는 두 단말이 NAT 내에 있을 때에도 통신이 가능하게 해주는 방법을 `NAT Home Puncing` 이라고 한다. 

말그대로 NAT라는 벽에 구멍(Hole)을 뚨어(Punching) 통신이 가능하게 해주는 방법이다. 

NAT를 통과하는 통신에 대한 정의 및 동작이 [RFC5128](https://datatracker.ietf.org/doc/html/rfc5128)에 자세히 설명되어 있다. 이는 표준이 아니고 그냥 단말이 NAT 를 통과하는 통신에 대한 정의 와 통신 방식에 대해 설명한 것이다. 이글에서 설명하는 Hole Puncing 기법도 이 글에 